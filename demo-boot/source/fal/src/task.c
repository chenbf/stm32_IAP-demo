/**
  ******************************************************************************
  * @file           : task.c
  * @brief          : 任务管理 - task manage
  ******************************************************************************
  * @attention
  *
  * Copyright: https://blog.csdn.net/qq_30155503
  * All rights reserved.
  *
  ******************************************************************************
  */
 
/*****************************************************************
* 包含头文件
******************************************************************/
#include <stdio.h>

#include "BSP.h"
#include "fal.h"
#include "task.h"
#include "tim.h"
#include "pal.h"
#include "cpuFlash.h"
#include "update.h"



/*****************************************************************
* 宏定义
******************************************************************/

/*****************************************************************
* 结构定义
******************************************************************/

/*****************************************************************
* 全局变量定义
******************************************************************/

/*****************************************************************
* 外部变量声明
******************************************************************/

/*****************************************************************
* 静态变量定义
******************************************************************/

/*****************************************************************
* 函数原型声明
******************************************************************/

/****************************************************************
* Func 	:
* Desc	:	主循环一轮执行一次的函数
* Input	:
* Output:
* Return:
*****************************************************************/
void Task_EachRound(void)
{

	/* 协议处理 */
	pal_Task();
	
}

/****************************************************************
* Func 	:
* Desc	:	处理高级任务函数
* Input	:
* Output:
* Return:
*****************************************************************/
void Deal_HighRank_Task(void)
{

	if(Timer_CheckMark(TIMER_LEVEL_HIGH) == 0)	// 每10ms 处理一次以下语句
	{

	}

}


/****************************************************************
* Func 	:
* Desc	:	处理中级任务函数
* Input	:
* Output:
* Return:
*****************************************************************/
void Deal_MiddleRank_Task(void)
{
	
	if(Timer_CheckMark(TIMER_LEVEL_MID) == 0)	// 每200ms 处理一次以下语句
	{
		
		/* 喂狗 */
		GPIO_feedDog();
	}

}


/****************************************************************
* Func 	:
* Desc	:	处理低级任务函数
* Input	:
* Output:
* Return:
*****************************************************************/
void Deal_LowRank_Task(void)
{
	Update_Status	eUpdSta;
	static UINT32	unFirstTick = 0;

	if(Timer_CheckMark(TIMER_LEVEL_LOW) == 0)	// 每2000ms 处理一次以下语句
	{

		if(unFirstTick == 0)
			unFirstTick = HAL_GetTick();

		/* 判断-若1min仍未开始升级则跳至APP */
		eUpdSta = update_getStatus();
		if(eUpdSta==UPD_STA_IDLE && HAL_GetTick()-unFirstTick >WAIT_UPDATE_TIMEOUT)
		{
			force_loadAPP(FLASH_PAGE_PARAM_START, FLASH_PAGE_APP_START, FLASH_APP_HEAD_SIZE);
		}
		
		/* 判断-若升级中但5min仍在bootloader则跳至APP */
		if(HAL_GetTick() -unFirstTick > ON_UPDATING_TIMEOUT)
		{
			force_loadAPP(FLASH_PAGE_PARAM_START, FLASH_PAGE_APP_START, FLASH_APP_HEAD_SIZE);
		}
	}

}



